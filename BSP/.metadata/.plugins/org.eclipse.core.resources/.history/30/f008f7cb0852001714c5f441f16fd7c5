#include <stdint.h>
#include<stdbool.h>
#include<stdio.h>
#include<string.h>
#include "slug.h"
#include "utils/uartstdio.h"
void testloadCellAmplifier2(void);
void testMotor2(void);
void testController2(void);

// Load Cell reading in pound
double loadCellOut, error, OutDuty;
char loadCellBuffer[80] = "test";

//Controller variables
// Load cell reading 45.83 pound is nominal
// Set Ref 50 pound
double setPointForce = 55;

//Motor
//static volatile uint32_t dutyCycle = 20;

//only for conversions
int intload, fracload, intErr, fracErr, intPWM, fracPWM, dir;
int sign = 1;

int main(void){
    //Setup system clock , 80MHZ
    Clock_set_fastest();

    //Configure Serial monitor
    initConsole();

    //Motor Initialize @ 10KHZ PWM freq
    uint32_t MotorPwmFreq = 10000; //10KHZ
    Motor_Init(MotorPwmFreq); // Initialize with 10KHZ
    UARTprintf("\n Motor Initialized! \n");

    //Load Cell Initialization
    LoadCell_init();
    UARTprintf("\n Load Cell Configured! \n");

    //Initialize debug LEDs
    RGBled_Init(0,1,1);

    //Controller initialize
//    setGoalForce(setPointForce);
//    uint32_t controllerFreq = 2000; //2 kHZ
//    Controller_Init(controllerFreq);
//    ControllerEnable();
//    UARTprintf("\n Controller Initialized! \n");

    //Initialize the logger
    uint32_t loggerFreq = 10; //10 Hz
    Logger_Init(loggerFreq);

    //Enable system wide interrupts
    EnableInterrupts();


    while(1){
//        //Measure Load Cell value
//        loadCellOut = measuredLoad();
//        intload = loadCellOut;
//        fracload = (loadCellOut - intload)*1000;
//
//        //Measure Error
//        error = getError();
//        if(error<0){
//            sign = -1;
//            error = error*sign;
//        }
//        intErr = error*sign;
//        fracErr = (error-intErr)*1000;
//
//        //PWM output
//        OutDuty = getPIDoutput();
//        if(OutDuty<0){
//            sign = -1;
//            OutDuty = OutDuty*sign;
//        }
//        intPWM = OutDuty*sign;
//        fracPWM = (OutDuty-intPWM)*1000;
//
//        //Direction
//        dir = getglobaldirection();


        //Turn Motor for some time and then reverse it
        //UARTprintf("F: %d.%3d, E:  %d.%3d, P:  %d.%3d, D:%d\n", intload, fracload,intErr, fracErr, intPWM, fracPWM, dir );
        //UARTprintf("Load:%04u, Error: %04u, PID_Out: %04u\n", (uint32_t)loadCellOut, (uint32_t)error, (uint32_t)OutDuty);
        motorSendCommand(10, 1);
        delayMS(1000);
        motorSendCommand(0, 1);
        delayMS(1000);
    }
}

